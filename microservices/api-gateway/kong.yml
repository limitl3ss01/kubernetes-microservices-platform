_format_version: "2.1"
_transform: true

services:
  - name: user-service
    url: http://user-service:3001
    routes:
      - name: user-service-routes
        paths:
          - /api/users
        strip_path: false
        preserve_host: true
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
          exposed_headers: ["X-Total-Count"]
          credentials: true
          max_age: 3600
      - name: prometheus
        config:
          status_codes: true
          latency: true
          bandwidth: true
          upstream_health: true

  - name: order-service
    url: http://order-service:3002
    routes:
      - name: order-service-routes
        paths:
          - /api/orders
        strip_path: false
        preserve_host: true
    plugins:
      - name: rate-limiting
        config:
          minute: 50
          hour: 500
          policy: local
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
          exposed_headers: ["X-Total-Count"]
          credentials: true
          max_age: 3600
      - name: prometheus
        config:
          status_codes: true
          latency: true
          bandwidth: true
          upstream_health: true

  - name: notification-service
    url: http://notification-service:3003
    routes:
      - name: notification-service-routes
        paths:
          - /api/notifications
        strip_path: false
        preserve_host: true
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000
          policy: local
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
          exposed_headers: ["X-Total-Count"]
          credentials: true
          max_age: 3600
      - name: prometheus
        config:
          status_codes: true
          latency: true
          bandwidth: true
          upstream_health: true

  - name: health-check-service
    url: http://user-service:3001
    routes:
      - name: health-check-routes
        paths:
          - /health
        strip_path: false
        preserve_host: true
    plugins:
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "OPTIONS"]
          headers: ["Content-Type"]
          credentials: true
          max_age: 3600

# Global plugins
plugins:
  - name: prometheus
    config:
      status_codes: true
      latency: true
      bandwidth: true
      upstream_health: true
      memory_stats: true
      worker_stats: true

  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true

  - name: request-transformer
    config:
      add:
        headers:
          - X-Gateway: Kong
          - X-Service: API-Gateway 